<source>
  @type forward
  port 5140
  bind 0.0.0.0
</source>

<filter worker.*>
  @type parser
  <parse>
    @type json
  </parse>
  key_name log
</filter>

<filter worker.*>
  @type record_transformer
  enable_ruby
  <record>
    message ${record["message"]}
    level ${record["level"]}
    task_id ${record["task_id"]}
  </record>
</filter>

<match worker.*>
 @type rewrite_tag_filter
 <rule>
   key     task_id
   pattern ^(.*)$
   tag worker_tagged.$1
 </rule>
</match>

<filter worker.*>
  @type record_transformer
  enable_ruby
  <record>
    file_path /fluentd/etc/log/${record["task_id"]}.log
  </record>
</filter>

<match worker_tagged.*>
  @type copy

  <store>
    @type file
    enable_ruby
    path /fluentd/etc/log/${tag}
    append true
    <buffer tag>
      flush_interval 1s    # 1秒ごとにフラッシュ
      chunk_limit_size 1MB # チャンクサイズの制限
    </buffer>
    <format>
      @type json
    </format>
  </store>

  <store>
    @type stdout
    <format>
      @type json
    </format>
  </store>
</match>