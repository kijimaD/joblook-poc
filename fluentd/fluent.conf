<source>
  @type forward
  port 5140
  bind 0.0.0.0
</source>

<filter worker.*>
  @type parser
  <parse>
    @type json
  </parse>
  key_name log
</filter>

<filter worker.*>
  @type record_transformer
  enable_ruby
  <record>
    message ${record["message"]}
    level ${record["level"]}
    task_id ${record["task_id"]}
  </record>
</filter>

<filter worker.*>
  @type record_transformer
  enable_ruby
  <record>
    file_path /fluentd/etc/log/${record["task_id"]}.log
  </record>
</filter>

<match worker.*>
  @type copy

  # 外部スクリプトでファイルに出力する
  # このディレクティブではほかでやっているようにtask_idを変数展開できなかったのでこうした
  <store>
    @type exec
    command "ruby /fluentd/etc/write_log.rb"
    buffer_type memory
    <format>
      @type json
    </format>
  </store>

  # 標準出力に出力
  <store>
    @type stdout
    <format>
      @type json
    </format>
  </store>
</match>